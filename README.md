# Server Client UDP

Проект представляет из себя сервис для передачи файлов, используя UDP пакеты.  
Содержит сервер и клиент, работающие на GNU/Linux.

## Использование

### Сборка
`make all` - сбока всего проекта</p>
`make server` - сборка сервера</p>
`make client` - сборка клиента</p>
`make clean` - очистка результатов сборки</p>
Сборка делается на g++ с флагами -Wall -std=c++11

### Запуск примеров
`make run` - сборка и запуск первого примера  
В этом случае сервер запускается с имитацией лагов, клиент передает серверу 2 текстовых файла из папки in</p>
`make runallfiles` - сборка и запуск второго примера  
В этом случае сервер запускается без имитации лагов, клиент передает серверу все 7 файлов из папки in</p>
__Замечание:__ `make run` и `make runallfiles` работают только на системах с gnome terminal. В этих системах запускаются два окна терминала с сервером и клиентом.

### Запуск и работа
`./server` для запуска сервера. При добавлении ключа `-lag` запускается с имитацией лагов (случайная задержка от 0 до 3 таймаутов в 2% случаев перед принятием пакета).</p>
`./client` для запуска клиента. Файлы, которые будут передаваться серверу, необходимо указать после, разделяя их пробелом.  
Пример: `./client "in/text1.txt" "in/file" "in/video.mp4"`</p>
Во время работы сервера и клиента в консоли показывается информация об их работе: время, выполняющийся процесс, некоторые сведения о переданном/полученном пакете.  
Сервер после получения последнего пакета с данными рассчитывает контрольную сумму файла и выводит ее на экран, а также сохраняет файл в папку out.
Серверу не передается информация о формате файла, так что он сохраняет его с именем идентификатора. 
Клиент после получения последнего пакета с контрольной суммой сверяет ее с суммой, вычисленной самостоятельно, и выводит результаты в консоль.
После отправки всех файлов клиент выводит все контрольные суммы в консоль.</p>
В файле allfunc.h можно изменить константы:  
`TIMEOUT` (ms) - если клиент на какой-то отправленный пакет не получает ответный пакет в течение таймаута, то отправленный пакет переотправляется  
`PACKETSIZE` (bytes) - размер пакета UDP  

## Принципы работы

### Формат заголовка пакетов
uint32 seq_number // номер пакета  
uint32 seq_total // количество пакетов с данными  
uint8 type // тип пакета: 0 == ACK, 1 == PUT  
byte id[8] // 8 байт - идентификатор, отличающий один файл от другого  
byte data[data_size] // после заголовка и до конца UDP пакета идут данные  


### Протокол взаимодействия
1. Клиент начинает отправлять данные серверу, используя пакеты типа PUT.
2. Сервер получает данные и записывает их в память, после каждого полученного пакета отправляя клиенту пакеты ACK.
3. Если клиент на какой-то отправленный пакет не получает ACK в течение таймаута, то отправленный пакет переотправляется.

### Особенности передачи
* Передача данных клиентом серверу идемпотентна - пакет может быть переотправлен несколько раз
* Передача порций данных может идти в произвольном порядке
* Между пакетами, относящимися к одному файлу, могут идти пакеты относящиеся к другому файлу
* Клиент специально отправляет пакеты в произвольном порядке

### Алгоритмы
Алгоритмы написаны согласно принципам работы. Детально об их работе можно посмотреть в коде, снабженном небольшими комментариями.

## Файлы
* server.cpp - сервер  
* client.cpp - клиент  
* allfunc.cpp - функции, используемые в сервере и клиенте  
* allfunc.h - заголовочный файл с константами, структурами и функциями  
* Makefile - makefile для быстрой сборки проекта и запуска примеров  
* in - папка с файлами разных форматов для примеров  

## Информация о системе
Ubuntu 20.04  
Linux 5.4.0-56-generic x86_64  
gcc version 9.3.0  
